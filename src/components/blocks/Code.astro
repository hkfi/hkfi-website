---
import Caption from './Caption.astro'
import type {
  CodeBlockObjectResponse,
  RichTextItemResponse,
  TextRichTextItemResponse
} from '@notionhq/client/build/src/api-endpoints'

import { codeToHtml } from 'shiki'
import {
  transformerNotationDiff,
  transformerNotationHighlight,
  transformerNotationErrorLevel
} from '@shikijs/transformers'
import { bundledLanguages, type BundledLanguage } from 'shiki/langs'

const VALID_LANGUAGES = Object.keys(bundledLanguages) as BundledLanguage[]

type ValidLanguage = (typeof VALID_LANGUAGES)[number]

function isValidLanguage(language: string): language is ValidLanguage {
  return VALID_LANGUAGES.includes(language as ValidLanguage)
}

export type Props = {
  block: CodeBlockObjectResponse
}

const { block } = Astro.props

function isTextRichTextItemResponse(
  richText: RichTextItemResponse
): richText is TextRichTextItemResponse {
  return 'text' in richText && 'content' in richText.text
}

const code = block.code.rich_text
  .map((richText) =>
    isTextRichTextItemResponse(richText) ? richText?.text?.content : ''
  )
  .join('')
const language = block.code.language.toLowerCase()

const htmlCode = await codeToHtml(code, {
  lang: language,
  themes: {
    light: 'rose-pine-dawn',
    dark: 'one-dark-pro'
  },
  transformers: [
    transformerNotationDiff(),
    transformerNotationHighlight(),
    transformerNotationErrorLevel()
  ]
})
---

<div class='code group relative' data-code={code}>
  {
    language === 'mermaid' ? (
      <pre set:html={htmlCode} />
    ) : isValidLanguage(block.code.language) ? (
      <div class='text-sm' set:html={htmlCode} />
    ) : null
  }
  <button
    class='copy-btn absolute right-2 top-2 rounded-md border border-text/10 bg-background/80 p-1.5 opacity-0 backdrop-blur-sm transition-all duration-200 hover:bg-background group-hover:opacity-100 focus:opacity-100 focus:ring-2 focus:ring-primary/50'
    aria-label='Copy code'
  >
    <svg
      class='copy-icon h-4 w-4 text-text/60'
      xmlns='http://www.w3.org/2000/svg'
      viewBox='0 0 24 24'
      fill='none'
      stroke='currentColor'
      stroke-width='2'
      stroke-linecap='round'
      stroke-linejoin='round'
    >
      <rect x='9' y='9' width='13' height='13' rx='2' ry='2'></rect>
      <path d='M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1'></path>
    </svg>
    <svg
      class='check-icon hidden h-4 w-4 text-primary'
      xmlns='http://www.w3.org/2000/svg'
      viewBox='0 0 24 24'
      fill='none'
      stroke='currentColor'
      stroke-width='2'
      stroke-linecap='round'
      stroke-linejoin='round'
    >
      <polyline points='20 6 9 17 4 12'></polyline>
    </svg>
  </button>
  <Caption richTexts={block.code.caption} />
</div>

<script is:inline data-astro-rerun>
  ;(() => {
    document.querySelectorAll('.code[data-code]').forEach((block) => {
      const btn = block.querySelector('.copy-btn')
      if (!btn || btn.dataset.initialized) return
      btn.dataset.initialized = 'true'

      btn.addEventListener('click', async (e) => {
        e.preventDefault()
        e.stopPropagation()
        const code = block.getAttribute('data-code')
        if (!code) return

        try {
          await navigator.clipboard.writeText(code)
          const copyIcon = btn.querySelector('.copy-icon')
          const checkIcon = btn.querySelector('.check-icon')
          copyIcon.classList.add('hidden')
          checkIcon.classList.remove('hidden')

          setTimeout(() => {
            copyIcon.classList.remove('hidden')
            checkIcon.classList.add('hidden')
          }, 2000)
        } catch (err) {
          console.error('Failed to copy:', err)
        }
      })
    })
  })()
</script>
