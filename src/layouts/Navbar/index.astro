---
import ThemeIcon from '@/components/ThemeIcon.astro'
import NavbarLink from './NavbarLink.astro'
import GithubIcon from './icons/Github.astro'
import XIcon from './icons/X.astro'
---

<div class='flex h-[72px] w-full justify-center'>
  <div
    id='navbar'
    class='duration-400 flex w-full max-w-6xl items-center gap-2 p-2 transition-all ease-in-out'
    transition:persist
  >
    <div class='flex w-2/5 items-center gap-4'>
      <ThemeIcon />
      <GithubIcon />
      <XIcon />
      <button
        id='command-palette-trigger'
        class='search-trigger border-0 bg-none'
        aria-label='Search (⌘K)'
        onclick='document.dispatchEvent(new CustomEvent("open-command-palette"))'
      >
        <svg
          xmlns='http://www.w3.org/2000/svg'
          viewBox='0 0 24 24'
          fill='none'
          stroke='currentColor'
          stroke-width='2'
          stroke-linecap='round'
          stroke-linejoin='round'
          class='h-6 stroke-text hover:stroke-primary'
        >
          <circle cx='11' cy='11' r='8'></circle>
          <line x1='21' x2='16.65' y1='21' y2='16.65'></line>
        </svg>
        <span class='search-tooltip' id='search-shortcut-hint'>⌘K</span>
      </button>
    </div>
    <div class='flex w-1/5 justify-center'>
      <NavbarLink href='/' label='hkfi' />
    </div>
    <div class='flex w-2/5 items-center justify-end gap-2'>
      <NavbarLink href='/about' label='About' />
      <NavbarLink href='/blog/1' label='Blog' />
    </div>
  </div>

  <div id='top-of-site-pixel-anchor' class='absolute top-0'></div>

  <div id='bottom-of-nav-pixel-anchor' class='absolute top-[50px]'></div>

  <script is:inline>
    if (
      'IntersectionObserver' in window &&
      'IntersectionObserverEntry' in window &&
      'intersectionRatio' in window.IntersectionObserverEntry.prototype
    ) {
      let observer = new IntersectionObserver((entries) => {
        if (entries[0].boundingClientRect.y < 0) {
          document.body.classList.add('header-not-at-top')
        } else {
          document.body.classList.remove('header-not-at-top')
        }
      })
      const pixelAnchor = document.querySelector('#bottom-of-nav-pixel-anchor')

      if (pixelAnchor) {
        observer.observe(pixelAnchor)
      }
    }

    const isMac = /(Mac|iPhone|iPod|iPad)/i.test(navigator?.platform)
    if (!isMac) {
      const hint = document.getElementById('search-shortcut-hint')
      if (hint) hint.textContent = 'Ctrl+K'
    }

    window.addEventListener('wheel', (e) => {
      const scrollDirection = e.deltaY < 1 ? 1 : e.deltaY > 1 ? -1 : 0

      const navbar = document.getElementById('navbar')

      if (scrollDirection === 1 && window.scrollY >= 50) {
        // Scroll up and scrolled over 50px
        navbar?.classList.remove('-translate-y-20', 'invisible', 'opacity-0')
        navbar?.classList.add('visible', 'opacity-100')
      } else if (scrollDirection === -1 && window.scrollY >= 50) {
        // Scroll down and scrolled over 50px
        navbar?.classList.add('invisible', 'opacity-0', '-translate-y-20')
        navbar?.classList?.remove('visible', 'opacity-100')
      }
    })
  </script>

  <script is:inline>
    ;(() => {
      if (!window.matchMedia('(pointer: fine)').matches) return

      const MAX_OFFSET = 4
      document.querySelectorAll('[data-magnetic]').forEach((el) => {
        if (el.dataset.magneticInit) return
        el.dataset.magneticInit = 'true'
        el.style.transition = 'transform 0.2s ease-out'
        el.style.willChange = 'transform'

        el.addEventListener('mousemove', (e) => {
          const rect = el.getBoundingClientRect()
          const centerX = rect.left + rect.width / 2
          const centerY = rect.top + rect.height / 2
          const moveX = ((e.clientX - centerX) / (rect.width / 2)) * MAX_OFFSET
          const moveY = ((e.clientY - centerY) / (rect.height / 2)) * MAX_OFFSET
          el.style.transform = `translate(${moveX}px, ${moveY}px)`
        })

        el.addEventListener('mouseleave', () => {
          el.style.transform = 'translate(0px, 0px)'
        })
      })
    })()
  </script>

  <style is:global>
    body #navbar {
      @apply z-10 px-3 py-1;
    }

    body.header-not-at-top #navbar {
      @apply fixed mt-1 h-[72px] rounded-lg bg-black/20 shadow-lg backdrop-blur;
    }
  </style>
</div>
