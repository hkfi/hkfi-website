---
import BlogTag from '@/components/BlogTag.astro'
import PostLink from '@/components/PostLink.astro'
import ScrollReveal from '@/components/ScrollReveal.astro'
import { getAllPosts, getAllTags, getAllPostCardData } from '@/libs/notion/client'
import type { PageObjectResponse } from '@notionhq/client/build/src/api-endpoints'
import type { Page, PaginateFunction } from 'astro'
import Layout from 'src/layouts/Layout.astro'
import ArrowRight from '@/components/icons/ArrowRight.astro'
import ArrowLeft from '@/components/icons/ArrowLeft.astro'

const tags = await getAllTags()

export async function getStaticPaths({
  paginate
}: {
  paginate: PaginateFunction
}) {
  const allPosts = await getAllPosts()

  return paginate(allPosts, { pageSize: 10 })
}

type Props = {
  page: Page<PageObjectResponse>
}

const { page } = Astro.props
const cardDataMap = await getAllPostCardData()
---

<Layout
  title='Blog | hkfi'
  seo={{
    description:
      'Engineering notes on web development, TypeScript, Python, and product-focused software work.'
  }}
>
  <div class='flex w-full flex-col gap-6 py-4'>
    <!-- Tags Filter -->
    <ScrollReveal animation='fade-up' duration={500} class='flex flex-wrap gap-2 p-2'>
      {tags.map((tag) => <BlogTag tag={tag} chosenTags={[]} />)}
    </ScrollReveal>

    <!-- Blog Grid -->
    <div class='grid w-full grid-cols-1 gap-4 md:grid-cols-2 lg:grid-cols-3'>
      {page.data.map((post, index) => (
        <ScrollReveal animation='fade-up' delay={index * 75} duration={500}>
          <PostLink post={post} cardData={cardDataMap.get(post.id)} />
        </ScrollReveal>
      ))}
    </div>

    <!-- Pagination -->
    <ScrollReveal animation='fade' delay={200} class='mt-8 flex w-full items-center justify-center gap-6'>
      {
        page.url.prev ? (
          <a
            class='flex items-center justify-center rounded-lg bg-secondary/50 px-4 py-3 text-primary transition-all hover:-translate-x-1 hover:bg-secondary hover:shadow-sm'
            href={page.url.prev}
            aria-label="Previous Page"
          >
            <ArrowLeft />
          </a>
        ) : (
          <div class='w-12'></div> /* Spacer */
        )
      }

      <div class='font-medium text-default/60'>
        Page <span class='text-primary font-bold'>{page.currentPage}</span> of {page.lastPage}
      </div>

      {
        page.url.next ? (
          <a
            class='flex items-center justify-center rounded-lg bg-secondary/50 px-4 py-3 text-primary transition-all hover:translate-x-1 hover:bg-secondary hover:shadow-sm'
            href={page.url.next}
            aria-label="Next Page"
          >
            <ArrowRight />
          </a>
        ) : (
          <div class='w-12'></div> /* Spacer */
        )
      }
    </ScrollReveal>
  </div>
</Layout>
