---
import BlogTag from '@/components/BlogTag.astro'
import PostBody from '@/components/PostBody.astro'
import {
  getAllPosts,
  getPostBySlug,
  getAllBlocksByBlockId
} from '@/libs/notion/client'
import Layout from 'src/layouts/Layout.astro'

export async function getStaticPaths() {
  const posts = await getAllPosts()

  return posts.map((post) => {
    const properties = post.properties

    const slug =
      'rich_text' in properties.Slug
        ? properties.Slug.rich_text[0].plain_text
        : ''

    return {
      params: {
        slug
      }
    }
  })
}

const { slug } = Astro.params

if (!slug) {
  throw new Error('slug is required')
}

const post = await getPostBySlug(slug)

if (!post) {
  throw new Error('Post not found. slug: ${slug}')
}

const [blocks] = await Promise.all([getAllBlocksByBlockId(post.id)])

const title =
  'title' in post.properties.Title
    ? post.properties.Title.title[0].plain_text
    : ''

const tags =
  'multi_select' in post.properties.Tags
    ? post.properties.Tags.multi_select
    : []

const date =
  'date' in post.properties.Date ? post.properties.Date.date?.start : ''
---

<Layout title={title}>
  <h1
    class='self-center text-3xl font-bold text-text'
    transition:name={`post-${post.id}`}
  >
    {title}
  </h1>
  <div class='flex items-center justify-between px-2'>
    <div>{date}</div>
    <div class='flex gap-2'>
      {tags.map((tag) => <BlogTag tag={tag} chosenTags={[]} />)}
    </div>
  </div>
  <PostBody blocks={blocks} />
</Layout>
